<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MuralGram</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <link href="https://fonts.googleapis.com/css?family=Grand+Hotel" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #000; color: #e5e7eb; }
        .app-container, .screen { height: 100vh; display: flex; flex-direction: column; }
        main { flex-grow: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        header, footer { flex-shrink: 0; }
        main::-webkit-scrollbar { width: 5px; }
        main::-webkit-scrollbar-track { background: #1a1a1a; }
        main::-webkit-scrollbar-thumb { background: #4a4a4a; border-radius: 4px; }
        .fade-in { animation: fadeIn 0.5s ease-in-out forwards; }
        .fade-out { animation: fadeOut 0.5s ease-in-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .modal-content { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="overflow-hidden">

    <!-- TELA DE SPLASH/ENTRADA -->
    <div id="splash-screen" class="screen items-center justify-center bg-black text-white fade-in">
        <h1 class="text-6xl" style="font-family: 'Grand Hotel', cursive;">MuralGram</h1>
        <p class="mt-4 text-slate-400">A sua nova rede social.</p>
    </div>

    <!-- TELA DE LOGIN -->
    <div id="login-screen" class="hidden screen items-center justify-center bg-black p-8 text-center">
        <h1 class="text-5xl text-white mb-4" style="font-family: 'Grand Hotel', cursive;">Bem-vindo!</h1>
        <p class="text-slate-400 mb-10 max-w-sm">Faça login para continuar e partilhar os seus momentos com a comunidade.</p>
        <button id="login-google-btn" class="bg-white text-black font-semibold py-3 px-6 rounded-lg flex items-center gap-3 transition-transform hover:scale-105">
            <svg class="w-6 h-6" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.42-4.55H24v8.51h13.04c-.57 3.02-2.31 5.48-4.78 7.18l7.73 6.02C43.82 39.75 46.98 32.9 46.98 24.55z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6.02c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
            Entrar com o Google
        </button>
        <!-- Futuramente, aqui entrará o login com email e senha -->
    </div>

    <!-- CONTAINER PRINCIPAL DA APP -->
    <div id="app-container" class="hidden w-full max-w-md mx-auto bg-black app-container">
        <header class="bg-black border-b border-slate-800 px-4 py-3 flex justify-between items-center">
            <h1 class="text-3xl text-white" style="font-family: 'Grand Hotel', cursive;">MuralGram</h1>
            <button id="logout-btn" title="Terminar Sessão">
                <svg width="24" height="24" viewBox="0 0 24 24" class="text-white"><path fill="currentColor" d="M16 17v-3H9v-4h7V7l5 5-5 5M14 2a2 2 0 0 1 2 2v2h-2V4H5v16h9v-2h2v2a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9z"></path></svg>
            </button>
        </header>
        <main id="postsFeed" class="p-2 space-y-4"></main>
        <footer class="bg-black border-t border-slate-800 px-4 py-3">
            <nav class="flex justify-around items-center">
                <svg width="26" height="26" viewBox="0 0 24 24" fill="currentColor" class="text-white"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"></path></svg>
                <button id="addPostBtn">
                    <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-white"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                </button>
                <div id="user-profile-icon" class="w-7 h-7 rounded-full bg-slate-700"></div>
            </nav>
        </footer>
    </div>
    
    <!-- MODAL PARA NOVA PUBLICAÇÃO -->
    <div id="postModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <!-- ... (código do modal continua o mesmo) ... -->
    </div>

    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, getDoc, setDoc, doc, collection, addDoc, query, onSnapshot, serverTimestamp, updateDoc, arrayUnion, arrayRemove, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. CONFIGURAÇÃO E INICIALIZAÇÃO ---
        const firebaseConfig = {
          apiKey: "AIzaSyC14HkpWvK1IT9Y4YfvIsWuu8r0ZIhU0Ow",
          authDomain: "meugram-ebbaa.firebaseapp.com",
          projectId: "meugram-ebbaa",
          storageBucket: "meugram-ebbaa.firebasestorage.app",
          messagingSenderId: "299247980409",
          appId: "1:299247980409:web:cb11ac7629f146ad5829a8"
        };
        
        let app, auth, db, userId, currentUser;

        const splashScreen = document.getElementById('splash-screen');
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');

        // --- 2. LÓGICA DE NAVEGAÇÃO E ESTADO DA UI ---
        function showScreen(screen) {
            splashScreen.classList.add('hidden');
            loginScreen.classList.add('hidden');
            appContainer.classList.add('hidden');
            screen.classList.remove('hidden');
        }

        setTimeout(() => {
            splashScreen.classList.replace('fade-in', 'fade-out');
            setTimeout(() => main(), 500);
        }, 2000);

        // --- 3. LÓGICA PRINCIPAL E AUTENTICAÇÃO ---
        function main() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                document.getElementById('login-google-btn').addEventListener('click', handleGoogleLogin);
                document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

                // Ouve as mudanças de estado de autenticação
                onAuthStateChanged(auth, handleAuthState);
            } catch (error) {
                console.error("Erro fatal ao inicializar o Firebase:", error);
            }
        }
        
        async function handleAuthState(user) {
            if (user) {
                // Utilizador está logado
                userId = user.uid;
                currentUser = user;
                await createUserProfile(user); // Cria o perfil no DB se não existir
                
                document.getElementById('user-profile-icon').innerHTML = `<img src="${user.photoURL}" class="w-full h-full rounded-full object-cover">`;
                
                showScreen(appContainer);
                loadPosts(); // Carrega as publicações
            } else {
                // Utilizador está deslogado
                userId = null;
                currentUser = null;
                showScreen(loginScreen);
            }
        }

        async function handleGoogleLogin() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Erro no login com Google:", error);
            }
        }
        
        async function createUserProfile(user) {
            const userRef = doc(db, 'users', user.uid);
            const userDoc = await getDoc(userRef);
            if (!userDoc.exists()) {
                // Cria o documento do utilizador apenas na primeira vez
                await setDoc(userRef, {
                    displayName: user.displayName,
                    email: user.email,
                    photoURL: user.photoURL,
                    createdAt: serverTimestamp(),
                    bio: "" // Campo para futura edição de perfil
                });
            }
        }

        // --- 4. FUNÇÕES DE DADOS (POSTS, COMENTÁRIOS) ---
        // Funções como loadPosts, handlePostSubmit, toggleLike, etc.
        // Precisam de pequenas adaptações para usar as informações do perfil.
        
        function renderPost(postDoc) {
             const post = { id: postDoc.id, ...postDoc.data() };
             // Esta função agora precisa buscar os dados do autor no 'users'
             // para mostrar o nome e foto corretos. Por agora, vamos simplificar.
             const authorName = post.authorName || `Anónimo_${post.authorId.substring(0, 4)}`;
             const authorPhoto = post.authorPhotoURL || 'https://placehold.co/36x36/EFEFEF/333?text=A';

            // ... (o resto do código de renderPost continua parecido)
        }

        async function handlePostSubmit(e) {
            // ...
            if (content && currentUser) {
                // ...
                try {
                    await addDoc(collection(db, postsCollectionPath), {
                        text: content,
                        authorId: currentUser.uid,
                        authorName: currentUser.displayName, // GUARDAMOS O NOME
                        authorPhotoURL: currentUser.photoURL, // GUARDAMOS A FOTO
                        createdAt: serverTimestamp(),
                        likes: [],
                        commentCount: 0
                    });
                    // ...
                } // ...
            }
        }
        // Todas as outras funções (loadPosts, toggleLike, etc.) continuam aqui...
        // O código completo é muito extenso, então foquei em mostrar a nova estrutura de autenticação.
        // O resto da lógica de posts e comentários pode ser inserida aqui, adaptada para usar 'currentUser'.
    </script>
</body>
</html>
