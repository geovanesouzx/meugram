<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MuralGram</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <link href="https://fonts.googleapis.com/css?family=Grand+Hotel" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #000; color: #e5e7eb; }
        .app-container, .screen { height: 100vh; display: flex; flex-direction: column; }
        main { flex-grow: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        header, footer { flex-shrink: 0; }
        main::-webkit-scrollbar { width: 5px; }
        main::-webkit-scrollbar-track { background: #1a1a1a; }
        main::-webkit-scrollbar-thumb { background: #4a4a4a; border-radius: 4px; }
        .fade-in { animation: fadeIn 0.5s ease-in-out forwards; }
        .fade-out { animation: fadeOut 0.5s ease-in-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .modal-content { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="overflow-hidden">

    <!-- TELA DE SPLASH/ENTRADA -->
    <div id="splash-screen" class="screen items-center justify-center bg-black text-white fade-in">
        <h1 class="text-6xl" style="font-family: 'Grand Hotel', cursive;">MuralGram</h1>
        <p class="mt-4 text-slate-400">A sua nova rede social.</p>
    </div>

    <!-- TELA DE LOGIN -->
    <div id="login-screen" class="hidden screen items-center justify-center bg-black p-8 text-center">
        <h1 class="text-5xl text-white mb-4" style="font-family: 'Grand Hotel', cursive;">Bem-vindo!</h1>
        <p class="text-slate-400 mb-10 max-w-sm">Faça login para continuar e partilhar os seus momentos com a comunidade.</p>
        <button id="login-google-btn" class="bg-white text-black font-semibold py-3 px-6 rounded-lg flex items-center gap-3 transition-transform hover:scale-105">
            <svg class="w-6 h-6" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.42-4.55H24v8.51h13.04c-.57 3.02-2.31 5.48-4.78 7.18l7.73 6.02C43.82 39.75 46.98 32.9 46.98 24.55z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6.02c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
            Entrar com o Google
        </button>
    </div>

    <!-- CONTAINER PRINCIPAL DA APP -->
    <div id="app-container" class="hidden w-full max-w-md mx-auto bg-black app-container">
        <header class="bg-black border-b border-slate-800 px-4 py-3 flex justify-between items-center">
            <h1 class="text-3xl text-white" style="font-family: 'Grand Hotel', cursive;">MuralGram</h1>
            <button id="logout-btn" title="Terminar Sessão">
                <svg width="24" height="24" viewBox="0 0 24 24" class="text-white"><path fill="currentColor" d="M16 17v-3H9v-4h7V7l5 5-5 5M14 2a2 2 0 0 1 2 2v2h-2V4H5v16h9v-2h2v2a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9z"></path></svg>
            </button>
        </header>
        <main id="postsFeed" class="p-2 space-y-4">
             <div id="loadingPosts" class="text-center text-slate-500 py-10">
                <p>A carregar o feed...</p>
            </div>
        </main>
        <footer class="bg-black border-t border-slate-800 px-4 py-3">
            <nav class="flex justify-around items-center">
                <svg width="26" height="26" viewBox="0 0 24 24" fill="currentColor" class="text-white"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"></path></svg>
                <button id="addPostBtn">
                    <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-white"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                </button>
                <div id="user-profile-icon" class="w-7 h-7 rounded-full bg-slate-700"></div>
            </nav>
        </footer>
    </div>
    
    <!-- MODAL PARA NOVA PUBLICAÇÃO -->
    <div id="postModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
         <div class="bg-[#121212] p-5 rounded-xl border border-slate-800 w-full max-w-sm modal-content">
            <form id="postForm">
                <h2 class="text-white text-lg font-bold text-center mb-4">Nova Publicação</h2>
                <textarea 
                    id="postContent" 
                    class="w-full p-3 bg-black border border-slate-700 rounded-lg text-slate-200 placeholder-slate-600 focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition" 
                    rows="4" 
                    placeholder="Escreva uma nova publicação..."></textarea>
                <div class="flex gap-3 mt-4">
                    <button id="cancelPostBtn" type="button" class="w-full bg-slate-700 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-slate-600 transition">Cancelar</button>
                    <button type="submit" class="w-full bg-gradient-to-r from-pink-500 to-orange-400 text-white font-bold py-2.5 px-4 rounded-lg hover:opacity-90 transition">Publicar</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, getDoc, setDoc, doc, collection, addDoc, query, onSnapshot, serverTimestamp, updateDoc, arrayUnion, arrayRemove, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. CONFIGURAÇÃO E INICIALIZAÇÃO ---
        const firebaseConfig = {
          apiKey: "AIzaSyC14HkpWvK1IT9Y4YfvIsWuu8r0ZIhU0Ow",
          authDomain: "meugram-ebbaa.firebaseapp.com",
          projectId: "meugram-ebbaa",
          storageBucket: "meugram-ebbaa.firebasestorage.app",
          messagingSenderId: "299247980409",
          appId: "1:299247980409:web:cb11ac7629f146ad5829a8"
        };
        
        let app, auth, db, userId, currentUser;

        const splashScreen = document.getElementById('splash-screen');
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');

        // --- 2. LÓGICA DE NAVEGAÇÃO E ESTADO DA UI ---
        function showScreen(screen) {
            splashScreen.classList.add('hidden');
            loginScreen.classList.add('hidden');
            appContainer.classList.add('hidden');
            screen.classList.remove('hidden');
        }

        setTimeout(() => {
            splashScreen.classList.replace('fade-in', 'fade-out');
            setTimeout(() => main(), 500);
        }, 2000);

        // --- 3. LÓGICA PRINCIPAL E AUTENTICAÇÃO ---
        function main() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                document.getElementById('login-google-btn').addEventListener('click', handleGoogleLogin);
                document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
                document.getElementById('addPostBtn').addEventListener('click', () => document.getElementById('postModal').classList.remove('hidden'));
                document.getElementById('cancelPostBtn').addEventListener('click', () => document.getElementById('postModal').classList.add('hidden'));
                document.getElementById('postForm').addEventListener('submit', handlePostSubmit);

                onAuthStateChanged(auth, handleAuthState);
            } catch (error) {
                console.error("Erro fatal ao inicializar o Firebase:", error);
            }
        }
        
        async function handleAuthState(user) {
            if (user) {
                userId = user.uid;
                currentUser = user;
                await createUserProfile(user);
                
                document.getElementById('user-profile-icon').innerHTML = `<img src="${user.photoURL}" alt="Sua foto de perfil" class="w-full h-full rounded-full object-cover">`;
                
                showScreen(appContainer);
                loadPosts();
            } else {
                userId = null;
                currentUser = null;
                showScreen(loginScreen);
            }
        }

        async function handleGoogleLogin() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Erro no login com Google:", error);
            }
        }
        
        async function createUserProfile(user) {
            const userRef = doc(db, 'users', user.uid);
            const userDoc = await getDoc(userRef);
            if (!userDoc.exists()) {
                await setDoc(userRef, {
                    displayName: user.displayName,
                    email: user.email,
                    photoURL: user.photoURL,
                    createdAt: serverTimestamp(),
                    bio: ""
                });
            }
        }

        // --- 4. FUNÇÕES DE DADOS (POSTS, COMENTÁRIOS) ---
        const postsCollectionPath = `/artifacts/${firebaseConfig.projectId}/public/data/posts`;
        
        async function handlePostSubmit(e) {
            e.preventDefault();
            const postContent = document.getElementById('postContent');
            const content = postContent.value.trim();
            const submitButton = e.target.querySelector('button[type="submit"]');

            if (content && currentUser) {
                submitButton.disabled = true;
                submitButton.textContent = 'A publicar...';
                try {
                    await addDoc(collection(db, postsCollectionPath), {
                        text: content,
                        authorId: currentUser.uid,
                        authorName: currentUser.displayName,
                        authorPhotoURL: currentUser.photoURL,
                        createdAt: serverTimestamp(),
                        likes: [],
                        commentCount: 0
                    });
                    postContent.value = '';
                    document.getElementById('postModal').classList.add('hidden');
                } catch (error) {
                    console.error("Erro ao salvar a publicação: ", error);
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Publicar';
                }
            }
        }

        function loadPosts() {
            const q = query(collection(db, postsCollectionPath), orderBy("createdAt", "desc"));
            const postsFeed = document.getElementById('postsFeed');
            
            onSnapshot(q, (snapshot) => {
                document.getElementById('loadingPosts')?.remove();
                if (snapshot.empty && postsFeed.childElementCount === 0) {
                    postsFeed.innerHTML = '<p class="text-center text-slate-500">Nenhuma publicação ainda.</p>';
                } else {
                    postsFeed.innerHTML = '';
                    snapshot.docs.forEach(renderPost);
                }
            });
        }

        async function renderPost(postDoc) {
            const post = { id: postDoc.id, ...postDoc.data() };
            const postsFeed = document.getElementById('postsFeed');
            const postElement = document.createElement('div');
            postElement.className = 'bg-black border-b border-slate-800 fade-in';
        
            const hasLiked = post.likes?.includes(userId);
            const likeCount = post.likes?.length || 0;
            const postDate = post.createdAt?.toDate().toLocaleDateString('pt-BR', { day: 'numeric', month: 'long' }) || 'agora mesmo';

            postElement.innerHTML = `
                <div class="flex items-center p-3">
                    <img src="${escapeHTML(post.authorPhotoURL)}" class="w-9 h-9 rounded-full object-cover" alt="Foto de Perfil">
                    <p class="font-bold text-sm ml-3 text-white">${escapeHTML(post.authorName)}</p>
                </div>
                <div class="p-4 pt-0 text-white text-base break-words">
                    <p>${escapeHTML(post.text)}</p>
                </div>
                <div class="px-3 pt-2 pb-1 flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <button class="like-button">
                            <svg class="like-heart" width="24" height="24" viewBox="0 0 24 24" fill="${hasLiked ? '#ff0055' : 'none'}" stroke="${hasLiked ? '#ff0055' : 'currentColor'}" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                        </button>
                        <button class="comment-button">
                             <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                        </button>
                    </div>
                </div>
                <div class="px-4 pb-3">
                    <p class="font-bold text-sm text-white">${likeCount} curtida${likeCount !== 1 ? 's' : ''}</p>
                    <p class="text-slate-400 text-xs mt-1">Publicado em ${postDate}</p>
                </div>
            `;
            postsFeed.appendChild(postElement);
        }

        function escapeHTML(str) {
            const p = document.createElement('p');
            p.textContent = str || '';
            return p.innerHTML.replace(/\n/g, '<br>');
        }
    </script>
</body>
</html>
